<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KWANDAA - Professional Delivery Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #1e293b;
            --primary-blue: #2563eb;
            --accent-red: #dc2626;
            --accent-orange: #ea580c;
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --border: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Enhanced Header */
        header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 50%, var(--accent-red) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 768px) {
            .header-content {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-red) 0%, var(--accent-orange) 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-md);
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Enhanced Tabs */
        .tabs {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 1.25rem 1rem;
            background: transparent;
            border: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-red) 100%);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn.active {
            color: var(--primary-dark);
            background: var(--surface-hover);
        }

        .tab-btn.active::before {
            transform: scaleX(1);
        }

        .tab-btn:hover {
            background: var(--surface-hover);
        }

        .tab-btn i {
            font-size: 1.1rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 1.375rem;
            color: var(--primary-dark);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .card-title i {
            color: var(--accent-red);
            font-size: 1.25rem;
        }

        /* Enhanced Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--primary-dark);
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--surface);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, var(--primary-blue) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-red) 0%, #b91c1c 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #b91c1c 0%, var(--accent-red) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, var(--success) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
        }

        /* Enhanced Camera Styles */
        .camera-preview {
            width: 100%;
            background: linear-gradient(135deg, var(--background) 0%, var(--surface-hover) 100%);
            border-radius: var(--radius);
            min-height: 240px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border: 2px dashed var(--border);
            transition: border-color 0.3s ease;
        }

        .camera-preview:hover {
            border-color: var(--primary-blue);
        }

        #cameraVideo, #cameraCapture {
            width: 100%;
            display: none;
            border-radius: var(--radius);
        }

        #cameraCapture {
            max-height: 300px;
            object-fit: contain;
        }

        .camera-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem 1rem;
        }

        .camera-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            color: var(--primary-blue);
            opacity: 0.7;
        }

        .camera-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .camera-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Camera selector */
        .camera-selector {
            margin-bottom: 1rem;
        }

        /* Enhanced Receipt Preview */
        .receipt-preview {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .receipt-preview::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent-red) 0%, transparent 70%);
            opacity: 0.1;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid var(--accent-red);
            position: relative;
        }

        .receipt-title {
            font-size: 1.75rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .receipt-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        .receipt-content {
            margin-top: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .receipt-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 480px) {
            .receipt-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        .receipt-item {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--surface-hover);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-blue);
        }

        .receipt-label {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .receipt-value {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
        }

        .barcode {
            text-align: center;
            margin: 2rem 0;
            font-family: 'Libre Barcode 128', cursive;
            font-size: 2.5rem;
            color: var(--primary-dark);
            padding: 1rem;
            background: var(--surface-hover);
            border-radius: var(--radius);
        }

        .signature-area {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px dashed var(--border);
            text-align: right;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (min-width: 480px) {
            .action-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Enhanced Delivery Cards */
        .delivery-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent-red);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            display: none;
        }

        .delivery-card.visible {
            display: block;
        }

        .delivery-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .delivery-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .delivery-id {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 1.1rem;
            letter-spacing: 0.025em;
        }

        .delivery-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .delivery-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        @media (min-width: 480px) {
            .delivery-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.825rem;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-view {
            background: var(--primary-dark);
            color: white;
        }

        .btn-view:hover {
            background: var(--primary-blue);
        }

        .btn-share {
            background: #25d366;
            color: white;
        }

        .btn-share:hover {
            background: #22c55e;
        }

        .btn-pdf {
            background: var(--accent-red);
            color: white;
        }

        .btn-pdf:hover {
            background: #b91c1c;
        }

        .btn-delete {
            background: var(--error);
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-restore {
            background: var(--success);
            color: white;
        }

        .btn-restore:hover {
            background: #059669;
        }

        /* Enhanced Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            opacity: 0.6;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        /* Enhanced Notification */
        .notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background: var(--primary-dark);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Enhanced Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            font-weight: 500;
        }

        /* Enhanced Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.375rem;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* PDF Preview */
        .pdf-preview-container {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            background: var(--background);
        }

        #pdfPreview {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        /* Search Section */
        .search-section {
            margin-bottom: 2rem;
        }

        /* History Tab Styles */
        .history-tabs {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .history-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .history-tab.active {
            color: var(--primary-dark);
            background: var(--surface-hover);
        }

        .history-tab:hover {
            background: var(--surface-hover);
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .main-content {
                padding: 1rem 0.75rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .header-content {
                padding: 0 1rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 1rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .camera-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-truck-fast"></i>
                    </div>
                    <span class="logo-text">KWANDAA</span>
                </div>
                <p class="tagline">Professional Delivery Management System</p>
            </div>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-btn active" data-tab="delivery">
                    <i class="fas fa-plus-circle"></i> New Delivery
                </button>
                <button class="tab-btn" data-tab="search">
                    <i class="fas fa-search"></i> Find Deliveries
                </button>
                <button class="tab-btn" data-tab="history">
                    <i class="fas fa-history"></i> History
                </button>
            </div>

            <!-- Delivery Form Tab -->
            <div class="tab-content active" id="delivery-tab">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-truck-loading"></i> Create New Delivery
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="senderName">Sender Name *</label>
                            <input type="text" id="senderName" placeholder="Full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="senderPhone">Sender Phone *</label>
                            <input type="tel" id="senderPhone" placeholder="Phone number" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiverName">Receiver Name *</label>
                            <input type="text" id="receiverName" placeholder="Full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiverPhone">Receiver Phone *</label>
                            <input type="tel" id="receiverPhone" placeholder="Phone number" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryAddress">Delivery Address *</label>
                        <textarea id="deliveryAddress" placeholder="Complete delivery address with landmarks" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="packageDescription">Package Description *</label>
                        <textarea id="packageDescription" placeholder="Describe package contents, weight, and special instructions" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="packageValue">Declared Value (RWF)</label>
                        <input type="number" id="packageValue" placeholder="Package value" min="0">
                    </div>
                    
                    <div class="form-group">
                        <h3 class="card-title" style="font-size: 1.1rem; margin-bottom: 1rem;">
                            <i class="fas fa-camera"></i> Proof of Delivery Photo
                        </h3>
                        
                        <div class="camera-selector">
                            <label for="cameraSelect">Select Camera:</label>
                            <select id="cameraSelect" class="camera-select">
                                <option value="user">Front Camera</option>
                                <option value="environment">Rear Camera</option>
                            </select>
                        </div>
                        
                        <div class="camera-preview">
                            <div class="camera-placeholder">
                                <i class="fas fa-camera"></i>
                                <p>No image captured yet</p>
                                <p style="font-size: 0.875rem; opacity: 0.7;">Take a photo for proof of delivery</p>
                            </div>
                            <video id="cameraVideo" autoplay></video>
                            <canvas id="cameraCanvas" style="display: none;"></canvas>
                            <img id="cameraCapture" alt="Captured image">
                        </div>
                        <div class="camera-buttons">
                            <button type="button" class="btn btn-primary" id="startCamera">
                                <i class="fas fa-camera"></i> Open Camera
                            </button>
                            <button type="button" class="btn btn-primary" id="capturePhoto" disabled>
                                <i class="fas fa-camera-retro"></i> Capture
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetCamera" disabled>
                                <i class="fas fa-redo"></i> Retake
                            </button>
                            <button type="button" class="btn btn-secondary" id="switchCamera" disabled>
                                <i class="fas fa-sync"></i> Switch Camera
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-full" id="generateDeliveryBtn">
                        <i class="fas fa-paper-plane"></i> Generate Delivery Receipt
                    </button>
                </div>
                
                <div class="receipt-preview">
                    <div class="receipt-header">
                        <h2 class="receipt-title">KWANDAA Delivery Receipt</h2>
                        <p class="receipt-subtitle">Proof of Delivery</p>
                    </div>
                    
                    <div class="receipt-content">
                        <div class="receipt-details">
                            <div class="receipt-item">
                                <div class="receipt-label">Delivery ID</div>
                                <div class="receipt-value">KW-<span id="previewDeliveryId">238749</span></div>
                            </div>
                            <div class="receipt-item">
                                <div class="receuit-label">Date Created</div>
                                <div class="receipt-value" id="previewDate">01 Sep 2023</div>
                            </div>
                            <div class="receipt-item">
                                <div class="receipt-label">Sender</div>
                                <div class="receipt-value" id="previewSender">John Doe</div>
                            </div>
                            <div class="receipt-item">
                                <div class="receipt-label">Receiver</div>
                                <div class="receipt-value" id="previewReceiver">Jane Smith</div>
                            </div>
                            <div class="receipt-item">
                                <div class="receipt-label">Sender Phone</div>
                                <div class="receipt-value" id="previewSenderPhone">+250 78 123 4567</div>
                            </div>
                            <div class="receipt-item">
                                <div class="receipt-label">Receiver Phone</div>
                                <div class="receipt-value" id="previewReceiverPhone">+250 78 987 6543</div>
                            </div>
                        </div>
                        
                        <div class="receipt-item">
                            <div class="receipt-label">Delivery Address</div>
                            <div class="receipt-value" id="previewAddress">123 Main Street, Kigali, Rwanda</div>
                        </div>
                        
                        <div class="receipt-item">
                            <div class="receipt-label">Package Details</div>
                            <div class="receipt-value" id="previewPackage">Electronic device</div>
                        </div>
                        
                        <div class="receipt-item">
                            <div class="receipt-label">Package Value</div>
                            <div class="receuit-value" id="previewValue">50,000 RWF</div>
                        </div>
                        
                        <div class="barcode">
                            *KW-238749*
                        </div>
                        
                        <div class="signature-area">
                            <p>Receiver's Signature: _________________________</p>
                            <p>Date: <span id="previewSignDate">01 Sep 2023</span></p>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" id="downloadReceiptBtn">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <button class="btn btn-secondary" id="shareWhatsAppBtn">
                            <i class="fab fa-whatsapp"></i> Share via WhatsApp
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Tab -->
            <div class="tab-content" id="search-tab">
                <div class="card search-section">
                    <h2 class="card-title">
                        <i class="fas fa-search"></i> Find Deliveries
                    </h2>
                    
                    <div class="form-group">
                        <label for="searchInput">Search by Name, Phone, or Delivery ID</label>
                        <input type="text" id="searchInput" placeholder="Enter search term">
                    </div>
                    
                    <button class="btn btn-primary btn-full" id="searchBtn">
                        <i class="fas fa-search"></i> Search Deliveries
                    </button>
                </div>
                
                <div class="search-results">
                    <h2 class="card-title">
                        <i class="fas fa-list"></i> Search Results
                    </h2>
                    <div id="searchResults">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No search performed yet</h3>
                            <p>Enter a search term to find deliveries</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i> Delivery History
                    </h2>
                    
                    <div class="history-tabs">
                        <button class="history-tab active" data-history-tab="active">
                            <i class="fas fa-box"></i> Active Deliveries
                        </button>
                        <button class="history-tab" data-history-tab="deleted">
                            <i class="fas fa-trash"></i> Recycle Bin
                        </button>
                    </div>
                    
                    <div id="deliveryHistory">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No delivery history</h3>
                            <p>Your delivery history will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notificationText">Operation completed successfully!</span>
        </div>

        <!-- PDF Preview Modal -->
        <div class="modal" id="pdfModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">PDF Preview</h3>
                    <button class="modal-close" id="closePdfModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="pdf-preview-container">
                        <div id="pdfPreview">
                            <!-- PDF content will be inserted here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="downloadPdfBtn">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button class="btn btn-secondary" id="closePdfBtn">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>Â© 2023 KWANDAA Delivery Management System | Data stored locally in your browser</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize date fields
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            
            // Set preview dates
            const previewDateElements = document.querySelectorAll('#previewDate, #previewSignDate');
            previewDateElements.forEach(el => {
                el.textContent = formatDate(today);
            });
            
            // Generate random delivery ID
            const deliveryId = 'KW-' + Math.floor(100000 + Math.random() * 900000);
            document.getElementById('previewDeliveryId').textContent = deliveryId;
            
            // Initialize local storage if empty
            if (!localStorage.getItem('kwandaaDeliveries')) {
                localStorage.setItem('kwandaaDeliveries', JSON.stringify([]));
            }
            
            // Initialize deleted deliveries storage if empty
            if (!localStorage.getItem('kwandaaDeletedDeliveries')) {
                localStorage.setItem('kwandaaDeletedDeliveries', JSON.stringify([]));
            }
            
            // Tab functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    // Update active tab button
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update active tab content
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // If search tab is opened, load all deliveries
                    if (tabId === 'search') {
                        loadAllDeliveries();
                    } else if (tabId === 'history') {
                        loadDeliveryHistory();
                    }
                });
            });
            
            // History tab functionality
            const historyTabs = document.querySelectorAll('.history-tab');
            
            historyTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const historyTabId = tab.getAttribute('data-history-tab');
                    
                    // Update active history tab button
                    historyTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Load appropriate history
                    if (historyTabId === 'active') {
                        loadActiveDeliveries();
                    } else if (historyTabId === 'deleted') {
                        loadDeletedDeliveries();
                    }
                });
            });
            
            // Camera functionality
            const startCameraBtn = document.getElementById('startCamera');
            const capturePhotoBtn = document.getElementById('capturePhoto');
            const resetCameraBtn = document.getElementById('resetCamera');
            const switchCameraBtn = document.getElementById('switchCamera');
            const cameraSelect = document.getElementById('cameraSelect');
            
            const cameraVideo = document.getElementById('cameraVideo');
            const cameraCanvas = document.getElementById('cameraCanvas');
            const cameraCapture = document.getElementById('cameraCapture');
            const cameraPlaceholder = document.querySelector('.camera-placeholder');
            
            let stream = null;
            let capturedImageData = null;
            let availableCameras = [];
            let currentCameraIndex = 0;
            
            // Function to get available cameras
            async function getCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    availableCameras = videoDevices;
                    
                    // Update camera select dropdown
                    cameraSelect.innerHTML = '';
                    availableCameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.text = camera.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    return availableCameras;
                } catch (err) {
                    console.error('Error enumerating cameras:', err);
                    return [];
                }
            }
            
            // Function to start camera with specific facing mode
            async function startCamera(facingMode = 'user') {
                try {
                    // Stop any existing stream
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    const constraints = {
                        video: {
                            facingMode: facingMode
                        },
                        audio: false
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraVideo.srcObject = stream;
                    cameraVideo.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                    startCameraBtn.disabled = true;
                    capturePhotoBtn.disabled = false;
                    resetCameraBtn.disabled = false;
                    switchCameraBtn.disabled = false;
                } catch (err) {
                    // If facingMode fails, try with deviceId
                    try {
                        const cameras = await getCameras();
                        if (cameras.length > 0) {
                            const constraints = {
                                video: { deviceId: { exact: cameraSelect.value } },
                                audio: false
                            };
                            
                            stream = await navigator.mediaDevices.getUserMedia(constraints);
                            cameraVideo.srcObject = stream;
                            cameraVideo.style.display = 'block';
                            cameraPlaceholder.style.display = 'none';
                            startCameraBtn.disabled = true;
                            capturePhotoBtn.disabled = false;
                            resetCameraBtn.disabled = false;
                            switchCameraBtn.disabled = false;
                        } else {
                            alert('Unable to access camera: ' + err.message);
                            console.error('Error accessing camera:', err);
                        }
                    } catch (err2) {
                        alert('Unable to access camera: ' + err2.message);
                        console.error('Error accessing camera:', err2);
                    }
                }
            }
            
            startCameraBtn.addEventListener('click', async () => {
                const facingMode = cameraSelect.value;
                await startCamera(facingMode);
            });
            
            // Switch camera functionality
            switchCameraBtn.addEventListener('click', async () => {
                if (availableCameras.length <= 1) {
                    showNotification('Only one camera available', 'error');
                    return;
                }
                
                currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
                const nextCameraId = availableCameras[currentCameraIndex].deviceId;
                
                try {
                    // Stop current stream
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Start new stream with next camera
                    const constraints = {
                        video: { deviceId: { exact: nextCameraId } },
                        audio: false
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraVideo.srcObject = stream;
                } catch (err) {
                    console.error('Error switching camera:', err);
                    showNotification('Error switching camera', 'error');
                }
            });
            
            capturePhotoBtn.addEventListener('click', () => {
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraVideo.videoWidth;
                cameraCanvas.height = cameraVideo.videoHeight;
                context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
                
                // Convert to data URL for preview
                capturedImageData = cameraCanvas.toDataURL('image/png');
                cameraCapture.src = capturedImageData;
                cameraCapture.style.display = 'block';
                cameraVideo.style.display = 'none';
                
                // Stop camera stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            });
            
            resetCameraBtn.addEventListener('click', () => {
                cameraCapture.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                capturedImageData = null;
                
                // Re-enable camera button
                startCameraBtn.disabled = false;
                capturePhotoBtn.disabled = true;
                switchCameraBtn.disabled = true;
            });
            
            // Get available cameras on page load
            getCameras();
            
            // Delivery form functionality
            const generateDeliveryBtn = document.getElementById('generateDeliveryBtn');
            const downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
            const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
            
            generateDeliveryBtn.addEventListener('click', function() {
                // Validate form
                const requiredFields = [
                    'senderName', 'senderPhone', 'receiverName', 
                    'receiverPhone', 'deliveryAddress', 'packageDescription'
                ];
                
                let isValid = true;
                requiredFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (!element.value.trim()) {
                        element.style.borderColor = 'var(--accent-red)';
                        isValid = false;
                    } else {
                        element.style.borderColor = 'var(--border)';
                    }
                });
                
                if (!isValid) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Save to local storage
                const deliveryData = {
                    id: deliveryId,
                    date: new Date().toISOString(),
                    senderName: document.getElementById('senderName').value,
                    senderPhone: document.getElementById('senderPhone').value,
                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    packageDescription: document.getElementById('packageDescription').value,
                    packageValue: document.getElementById('packageValue').value,
                    imageData: capturedImageData,
                    status: 'active'
                };
                
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                deliveries.push(deliveryData);
                localStorage.setItem('kwandaaDeliveries', JSON.stringify(deliveries));
                
                // Update preview
                document.getElementById('previewSender').textContent = deliveryData.senderName;
                document.getElementById('previewReceiver').textContent = deliveryData.receiverName;
                document.getElementById('previewSenderPhone').textContent = deliveryData.senderPhone;
                document.getElementById('previewReceiverPhone').textContent = deliveryData.receiverPhone;
                document.getElementById('previewAddress').textContent = deliveryData.deliveryAddress;
                document.getElementById('previewPackage').textContent = deliveryData.packageDescription;
                document.getElementById('previewValue').textContent = deliveryData.packageValue ? `${parseInt(deliveryData.packageValue).toLocaleString()} RWF` : 'Not specified';
                
                showNotification('Delivery saved successfully! Receipt is ready to download.');
            });
            
            downloadReceiptBtn.addEventListener('click', function() {
                generateReceiptPdf();
            });
            
            shareWhatsAppBtn.addEventListener('click', function() {
                // Create WhatsApp share message
                const deliveryId = document.getElementById('previewDeliveryId').textContent;
                const senderName = document.getElementById('previewSender').textContent;
                const receiverName = document.getElementById('previewReceiver').textContent;
                
                const message = `KWANDAA Delivery Receipt\n\nDelivery ID: KW-${deliveryId}\nSender: ${senderName}\nReceiver: `;
                
                // Encode message for WhatsApp URL
                const encodedMessage = encodeURIComponent(message);
                
                // Open WhatsApp with the message
                window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
                
                showNotification('WhatsApp sharing launched');
            });
            
            // Search functionality
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            
            searchBtn.addEventListener('click', function() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    loadAllDeliveries();
                    return;
                }
                
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                const results = deliveries.filter(delivery => 
                    delivery.senderName.toLowerCase().includes(searchTerm) ||
                    delivery.receiverName.toLowerCase().includes(searchTerm) ||
                    delivery.senderPhone.includes(searchTerm) ||
                    delivery.receiverPhone.includes(searchTerm) ||
                    delivery.id.toLowerCase().includes(searchTerm)
                );
                
                displaySearchResults(results);
            });
            
            function loadAllDeliveries() {
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                const activeDeliveries = deliveries.filter(d => d.status !== 'deleted');
                displaySearchResults(activeDeliveries);
            }
            
            function loadDeliveryHistory() {
                loadActiveDeliveries();
            }
            
            function loadActiveDeliveries() {
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                const activeDeliveries = deliveries.filter(d => d.status !== 'deleted');
                displayHistoryResults(activeDeliveries, 'active');
            }
            
            function loadDeletedDeliveries() {
                const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                displayHistoryResults(deletedDeliveries, 'deleted');
            }
            
            function displaySearchResults(results) {
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No deliveries found</h3>
                            <p>Try a different search term or create a new delivery</p>
                        </div>
                    `;
                    return;
                }
                
                resultsContainer.innerHTML = '';
                
                // Show latest first
                results = [...results].reverse();
                
                results.forEach(delivery => {
                    const deliveryDate = new Date(delivery.date);
                    const deliveryCard = document.createElement('div');
                    deliveryCard.className = 'delivery-card visible';
                    deliveryCard.innerHTML = `
                        <div class="delivery-card-header">
                            <span class="delivery-id">${delivery.id}</span>
                            <span class="delivery-date">${formatDate(deliveryDate)}</span>
                        </div>
                        <div class="delivery-details">
                            <div>
                                <strong>Sender:</strong> ${delivery.senderName}<br>
                                <strong>Phone:</strong> ${delivery.senderPhone}
                            </div>
                            <div>
                                <strong>Receiver:</strong> ${delivery.receiverName}<br>
                                <strong>Phone:</strong> ${delivery.receiverPhone}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="action-btn btn-view" data-id="${delivery.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn btn-pdf" data-id="${delivery.id}">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="action-btn btn-share" data-id="${delivery.id}">
                                <i class="fab fa-whatsapp"></i> Share
                            </button>
                            <button class="action-btn btn-delete" data-id="${delivery.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    resultsContainer.appendChild(deliveryCard);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.btn-view').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        viewDeliveryDetails(deliveryId);
                    });
                });
                
                document.querySelectorAll('.btn-pdf').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        generateDeliveryReceiptPdf(deliveryId);
                    });
                });
                
                document.querySelectorAll('.btn-share').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        shareDeliveryReceipt(deliveryId);
                    });
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        deleteDelivery(deliveryId, 'search');
                    });
                });
            }
            
            function displayHistoryResults(results, type = 'active') {
                const historyContainer = document.getElementById('deliveryHistory');
                
                if (results.length === 0) {
                    const message = type === 'active' 
                        ? 'No active deliveries' 
                        : 'Recycle bin is empty';
                    
                    historyContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>${message}</h3>
                            <p>Your ${type === 'active' ? 'delivery history' : 'recycle bin'} will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                // Reverse to show latest first
                results = [...results].reverse();
                
                historyContainer.innerHTML = '';
                
                results.forEach(delivery => {
                    const deliveryDate = new Date(delivery.date);
                    const deliveryCard = document.createElement('div');
                    deliveryCard.className = 'delivery-card visible';
                    
                    if (type === 'active') {
                        deliveryCard.innerHTML = `
                            <div class="delivery-card-header">
                                <span class="delivery-id">${delivery.id}</span>
                                <span class="delivery-date">${formatDate(deliveryDate)}</span>
                            </div>
                            <div class="delivery-details">
                                <div>
                                    <strong>Sender:</strong> ${delivery.senderName}<br>
                                    <strong>Phone:</strong> ${delivery.senderPhone}
                                </div>
                                <div>
                                    <strong>Receiver:</strong> ${delivery.receiverName}<br>
                                    <strong>Phone:</strong> ${delivery.receiverPhone}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn btn-view" data-id="${delivery.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn btn-pdf" data-id="${delivery.id}">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="action-btn btn-share" data-id="${delivery.id}">
                                    <i class="fab fa-whatsapp"></i> Share
                                </button>
                                <button class="action-btn btn-delete" data-id="${delivery.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                    } else {
                        deliveryCard.innerHTML = `
                            <div class="delivery-card-header">
                                <span class="delivery-id">${delivery.id}</span>
                                <span class="delivery-date">${formatDate(deliveryDate)}</span>
                            </div>
                            <div class="delivery-details">
                                <div>
                                    <strong>Sender:</strong> ${delivery.senderName}<br>
                                    <strong>Phone:</strong> ${delivery.senderPhone}
                                </div>
                                <div>
                                    <strong>Receiver:</strong> ${delivery.receiverName}<br>
                                    <strong>Phone:</strong> ${delivery.receiverPhone}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn btn-view" data-id="${delivery.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn btn-pdf" data-id="${delivery.id}">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="action-btn btn-restore" data-id="${delivery.id}">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                                <button class="action-btn btn-delete" data-id="${delivery.id}">
                                    <i class="fas fa-trash-alt"></i> Permanent Delete
                                </button>
                            </div>
                        `;
                    }
                    
                    historyContainer.appendChild(deliveryCard);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.btn-view').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        viewDeliveryDetails(deliveryId);
                    });
                });
                
                document.querySelectorAll('.btn-pdf').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        generateDeliveryReceiptPdf(deliveryId);
                    });
                });
                
                document.querySelectorAll('.btn-share').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        shareDeliveryReceipt(deliveryId);
                    });
                });
                
                if (type === 'active') {
                    document.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const deliveryId = this.getAttribute('data-id');
                            deleteDelivery(deliveryId, 'history');
                        });
                    });
                } else {
                    document.querySelectorAll('.btn-restore').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const deliveryId = this.getAttribute('data-id');
                            restoreDelivery(deliveryId);
                        });
                    });
                    
                    document.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const deliveryId = this.getAttribute('data-id');
                            permanentDeleteDelivery(deliveryId);
                        });
                    });
                }
            }
            
            function viewDeliveryDetails(deliveryId) {
                // Check active deliveries first
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                let delivery = deliveries.find(d => d.id === deliveryId);
                
                // If not found in active, check deleted
                if (!delivery) {
                    const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                    delivery = deletedDeliveries.find(d => d.id === deliveryId);
                }
                
                if (delivery) {
                    alert(`
                        Delivery Details:
                        ID: ${delivery.id}
                        Date: ${formatDate(new Date(delivery.date))}
                        Sender: ${delivery.senderName} (${delivery.senderPhone})
                        Receiver: ${delivery.receiverName} (${delivery.receiverPhone})
                        Address: ${delivery.deliveryAddress}
                        Package: ${delivery.packageDescription}
                        Value: ${delivery.packageValue || 'Not specified'} RWF
                    `);
                }
            }
            
            function generateDeliveryReceiptPdf(deliveryId) {
                // Check active deliveries first
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                let delivery = deliveries.find(d => d.id === deliveryId);
                
                // If not found in active, check deleted
                if (!delivery) {
                    const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                    delivery = deletedDeliveries.find(d => d.id === deliveryId);
                }
                
                if (delivery) {
                    // Create PDF preview
                    const pdfPreview = document.getElementById('pdfPreview');
                    pdfPreview.innerHTML = `
                        <div style="padding: 20px; font-family: 'Inter', sans-serif;">
                            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #dc2626; padding-bottom: 15px;">
                                <h1 style="color: #1e293b; margin-bottom: 5px;">KWANDAA Delivery Receipt</h1>
                                <p style="color: #64748b;">Proof of Delivery</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <strong>Delivery ID:</strong> ${delivery.id}
                                </div>
                                <div>
                                    <strong>Date:</strong> ${formatDate(new Date(delivery.date))}
                                </div>
                                <div>
                                    <strong>Sender:</strong> ${delivery.senderName}
                                </div>
                                <div>
                                    <strong>Receiver:</strong> ${delivery.receiverName}
                                </div>
                                <div>
                                    <strong>Sender Phone:</strong> ${delivery.senderPhone}
                                </div>
                                <div>
                                    <strong>Receiver Phone:</strong> ${delivery.receiverPhone}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <strong>Delivery Address:</strong><br>
                                ${delivery.deliveryAddress}
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <strong>Package Details:</strong><br>
                                ${delivery.packageDescription}
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <strong>Package Value:</strong> ${delivery.packageValue ? `${parseInt(delivery.packageValue).toLocaleString()} RWF` : 'Not specified'}
                            </div>
                            
                            ${delivery.imageData ? `
                            <div style="margin-bottom: 20px; text-align: center;">
                                <strong>Proof of Delivery Photo:</strong><br>
                                <img src="${delivery.imageData}" style="max-width: 100%; max-height: 300px; margin-top: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            </div>
                            ` : ''}
                            
                            <div style="text-align: center; margin: 30px 0; font-family: 'Libre Barcode 128', cursive; font-size: 36px;">
                                *${delivery.id}*
                            </div>
                            
                            <div style="margin-top: 40px; padding-top: 15px; border-top: 1px dashed #e2e8f0; text-align: right;">
                                <p>Receiver's Signature: _________________________</p>
                                <p>Date: ${formatDate(new Date(delivery.date))}</p>
                            </div>
                        </div>
                    `;
                    
                    // Show modal
                    document.getElementById('pdfModal').classList.add('show');
                    
                    // Store current delivery ID for download
                    document.getElementById('downloadPdfBtn').setAttribute('data-id', deliveryId);
                }
            }
            
            function shareDeliveryReceipt(deliveryId) {
                // Check active deliveries first
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                let delivery = deliveries.find(d => d.id === deliveryId);
                
                // If not found in active, check deleted
                if (!delivery) {
                    const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                    delivery = deletedDeliveries.find(d => d.id === deliveryId);
                }
                
                if (delivery) {
                    const message = `KWANDAA Delivery Receipt\n\nDelivery ID: ${delivery.id}\nDate: ${formatDate(new Date(delivery.date))}\nSender: ${delivery.senderName} (${delivery.senderPhone})\nReceiver: ${delivery.receiverName} (${delivery.receiverPhone})\nAddress: ${delivery.deliveryAddress}\nPackage: ${delivery.packageDescription}\nValue: ${delivery.packageValue || 'Not specified'} RWF`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
                    
                    showNotification('WhatsApp sharing launched for delivery ' + deliveryId);
                }
            }
            
            function deleteDelivery(deliveryId, source) {
                if (confirm('Are you sure you want to move this delivery to the recycle bin? You can restore it later.')) {
                    const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                    const deliveryIndex = deliveries.findIndex(d => d.id === deliveryId);
                    
                    if (deliveryIndex !== -1) {
                        // Get the delivery
                        const delivery = deliveries[deliveryIndex];
                        
                        // Add to deleted deliveries
                        const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                        deletedDeliveries.push(delivery);
                        localStorage.setItem('kwandaaDeletedDeliveries', JSON.stringify(deletedDeliveries));
                        
                        // Remove from active deliveries
                        deliveries.splice(deliveryIndex, 1);
                        localStorage.setItem('kwandaaDeliveries', JSON.stringify(deliveries));
                        
                        // Refresh the view
                        if (source === 'search') {
                            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                            if (!searchTerm) {
                                loadAllDeliveries();
                            } else {
                                document.getElementById('searchBtn').click();
                            }
                        } else if (source === 'history') {
                            loadActiveDeliveries();
                        }
                        
                        showNotification('Delivery moved to recycle bin');
                    }
                }
            }
            
            function restoreDelivery(deliveryId) {
                const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                const deliveryIndex = deletedDeliveries.findIndex(d => d.id === deliveryId);
                
                if (deliveryIndex !== -1) {
                    // Get the delivery
                    const delivery = deletedDeliveries[deliveryIndex];
                    
                    // Add back to active deliveries
                    const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                    deliveries.push(delivery);
                    localStorage.setItem('kwandaaDeliveries', JSON.stringify(deliveries));
                    
                    // Remove from deleted deliveries
                    deletedDeliveries.splice(deliveryIndex, 1);
                    localStorage.setItem('kwandaaDeletedDeliveries', JSON.stringify(deletedDeliveries));
                    
                    // Refresh the view
                    loadDeletedDeliveries();
                    
                    showNotification('Delivery restored successfully');
                }
            }
            
            function permanentDeleteDelivery(deliveryId) {
                if (confirm('Are you sure you want to permanently delete this delivery? This action cannot be undone.')) {
                    const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                    const updatedDeliveries = deletedDeliveries.filter(d => d.id !== deliveryId);
                    localStorage.setItem('kwandaaDeletedDeliveries', JSON.stringify(updatedDeliveries));
                    
                    // Refresh the view
                    loadDeletedDeliveries();
                    
                    showNotification('Delivery permanently deleted');
                }
            }
            
            // PDF Modal functionality
            document.getElementById('closePdfModal').addEventListener('click', function() {
                document.getElementById('pdfModal').classList.remove('show');
            });
            
            document.getElementById('closePdfBtn').addEventListener('click', function() {
                document.getElementById('pdfModal').classList.remove('show');
            });
            
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                const deliveryId = this.getAttribute('data-id');
                generatePdf(deliveryId);
            });
            
            function generatePdf(deliveryId) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Check active deliveries first
                const deliveries = JSON.parse(localStorage.getItem('kwandaaDeliveries'));
                let delivery = deliveries.find(d => d.id === deliveryId);
                
                // If not found in active, check deleted
                if (!delivery) {
                    const deletedDeliveries = JSON.parse(localStorage.getItem('kwandaaDeletedDeliveries'));
                    delivery = deletedDeliveries.find(d => d.id === deliveryId);
                }
                
                if (delivery) {
                    // Add logo and header
                    doc.setFillColor(30, 41, 59);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFontSize(20);
                    doc.setTextColor(255, 255, 255);
                    doc.text('KWANDAA DELIVERY RECEIPT', 105, 17, { align: 'center' });
                    doc.setFontSize(12);
                    doc.setTextColor(240, 240, 240);
                    doc.text('Proof of Delivery', 105, 24, { align: 'center' });
                    
                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                    
                    // Add delivery details
                    doc.setFontSize(12);
                    doc.text(`Delivery ID: ${delivery.id}`, 20, 45);
                    doc.text(`Date: ${formatDate(new Date(delivery.date))}`, 20, 52);
                    doc.text(`Sender: ${delivery.senderName} (${delivery.senderPhone})`, 20, 59);
                    doc.text(`Receiver: ${delivery.receiverName} (${delivery.receiverPhone})`, 20, 66);
                    
                    // Add delivery address
                    doc.text('Delivery Address:', 20, 80);
                    const splitAddress = doc.splitTextToSize(delivery.deliveryAddress, 170);
                    doc.text(splitAddress, 20, 87);
                    
                    // Add package details
                    const addressHeight = splitAddress.length * 6;
                    doc.text('Package Details:', 20, 87 + addressHeight + 5);
                    const splitPackage = doc.splitTextToSize(delivery.packageDescription, 170);
                    doc.text(splitPackage, 20, 87 + addressHeight + 12);
                    
                    // Add package value
                    const packageHeight = splitPackage.length * 6;
                    doc.text(`Package Value: ${delivery.packageValue ? `${parseInt(delivery.packageValue).toLocaleString()} RWF` : 'Not specified'}`, 20, 87 + addressHeight + packageHeight + 17);
                    
                    // Add image if available
                    let currentHeight = 87 + addressHeight + packageHeight + 24;
                    
                    if (delivery.imageData) {
                        doc.text('Proof of Delivery Photo:', 20, currentHeight);
                        currentHeight += 7;
                        
                        // Add image to PDF
                        doc.addImage(delivery.imageData, 'PNG', 20, currentHeight, 100, 80);
                        currentHeight += 90;
                    }
                    
                    // Add barcode
                    doc.setFontSize(28);
                    doc.text(`*${delivery.id}*`, 105, currentHeight + 10, { align: 'center' });
                    
                    // Add signature area
                    doc.setFontSize(12);
                    doc.text('Receiver Signature: _________________________', 20, currentHeight + 30);
                    doc.text(`Date: ${formatDate(new Date(delivery.date))}`, 20, currentHeight + 37);
                    
                    // Save the PDF
                    doc.save(`KWANDAA-Delivery-${delivery.id}.pdf`);
                    
                    // Close modal
                    document.getElementById('pdfModal').classList.remove('show');
                    
                    showNotification('PDF downloaded successfully');
                }
            }
            
            function generateReceiptPdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add logo and header
                doc.setFillColor(30, 41, 59);
                doc.rect(0, 0, 210, 30, 'F');
                doc.setFontSize(20);
                doc.setTextColor(255, 255, 255);
                doc.text('KWANDAA DELIVERY RECEIPT', 105, 17, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(240, 240, 240);
                doc.text('Proof of Delivery', 105, 24, { align: 'center' });
                
                // Reset text color
                doc.setTextColor(0, 0, 0);
                
                // Get values from preview
                const deliveryId = document.getElementById('previewDeliveryId').textContent;
                const date = document.getElementById('previewDate').textContent;
                const sender = document.getElementById('previewSender').textContent;
                const receiver = document.getElementById('previewReceiver').textContent;
                const senderPhone = document.getElementById('previewSenderPhone').textContent;
                const receiverPhone = document.getElementById('previewReceiverPhone').textContent;
                const address = document.getElementById('previewAddress').textContent;
                const packageDesc = document.getElementById('previewPackage').textContent;
                const value = document.getElementById('previewValue').textContent;
                
                // Add delivery details
                doc.setFontSize(12);
                doc.text(`Delivery ID: KW-${deliveryId}`, 20, 45);
                doc.text(`Date: ${date}`, 20, 52);
                doc.text(`Sender: ${sender} (${senderPhone})`, 20, 59);
                doc.text(`Receiver: ${receiver} (${receiverPhone})`, 20, 66);
                
                // Add delivery address
                doc.text('Delivery Address:', 20, 80);
                const splitAddress = doc.splitTextToSize(address, 170);
                doc.text(splitAddress, 20, 87);
                
                // Add package details
                const addressHeight = splitAddress.length * 6;
                doc.text('Package Details:', 20, 87 + addressHeight + 5);
                const splitPackage = doc.splitTextToSize(packageDesc, 170);
                doc.text(splitPackage, 20, 87 + addressHeight + 12);
                
                // Add package value
                const packageHeight = splitPackage.length * 6;
                doc.text(`Package Value: ${value}`, 20, 87 + addressHeight + packageHeight + 17);
                
                // Add image if available
                let currentHeight = 87 + addressHeight + packageHeight + 24;
                
                if (capturedImageData) {
                    doc.text('Proof of Delivery Photo:', 20, currentHeight);
                    currentHeight += 7;
                    
                    // Add image to PDF
                    doc.addImage(capturedImageData, 'PNG', 20, currentHeight, 100, 80);
                    currentHeight += 90;
                }
                
                // Add barcode
                doc.setFontSize(28);
                doc.text(`*KW-${deliveryId}*`, 105, currentHeight + 10, { align: 'center' });
                
                // Add signature area
                doc.setFontSize(12);
                doc.text('Receiver Signature: _________________________', 20, currentHeight + 30);
                doc.text(`Date: ${date}`, 20, currentHeight + 37);
                
                // Save the PDF
                doc.save(`KWANDAA-Delivery-KW-${deliveryId}.pdf`);
                
                showNotification('PDF downloaded successfully');
            }
            
            // Helper functions
            function formatDate(date) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
            
            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notificationText');
                
                notificationText.textContent = message;
                
                if (type === 'error') {
                    notification.style.background = 'var(--error)';
                } else {
                    notification.style.background = 'var(--primary-dark)';
                }
                
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        });
    </script>
</body>
</html>

